    let tariff: any;

    const preferredModes = (params.deliveryModes || [])
      .map((mode) => parseInt(String(mode), 10))
      .filter((mode) => Number.isFinite(mode));

    const filterByModes = (list: any[]) => {
      if (preferredModes.length === 0) {
        return list;
      }
      return list.filter((item: any) => {
        const mode = parseInt(String(item.delivery_mode), 10);
        return preferredModes.includes(mode);
      });
    };
    
    if (hasServices) {
      const filtered = filterByModes(tariffs);
      const sortedTariffs = (filtered.length > 0 ? filtered : tariffs).sort(
        (a: any, b: any) => {
          const costA = a.total_sum ?? a.delivery_sum ?? 0;
          const costB = b.total_sum ?? b.delivery_sum ?? 0;
          return costA - costB;
        }
      );
      tariff = sortedTariffs[0];
    } else {
      if (preferredModes.length > 0) {
        const filteredTariffs = filterByModes(tariffs);
        const sortedTariffs = (filteredTariffs.length > 0 ? filteredTariffs : tariffs).sort(
          (a: any, b: any) => {
            const costA = a.delivery_sum ?? a.total_sum ?? 0;
            const costB = b.delivery_sum ?? b.total_sum ?? 0;
            return costA - costB;
          }
        );
        tariff = sortedTariffs[0];
      
      }} else {

      // Для tarifflist выбираем тариф для ПВЗ (пункта выдачи)
      // delivery_mode значения для ПВЗ (отправка со склада):
      //   4 = склад-склад (основной вариант - склад отправителя → склад/ПВЗ получателя)
      //   7 = склад-постамат (альтернатива - склад отправителя → постамат/ПВЗ получателя)
      //
      // Типы тарифов (по приоритету от дешевого к дорогому):
      //   1. "Посылка" - обычная посылка (самый дешевый, ~345 руб для Москвы)
      //   2. "Экспресс" - экспресс доставка (средняя скорость, ~740 руб)
      //   3. "Супер-экспресс" - быстрая доставка (дороже, от 1660 руб)
      //   Примечание: "Магистральный экспресс" исключен (для больших грузов)
      const pvzDeliveryModes = [4, 7]; // Режимы для отправки со склада к ПВЗ
      
      // Фильтруем тарифы, подходящие для ПВЗ
      // Исключаем магистральный экспресс (для больших грузов)
      const pvzTariffs = tariffs.filter((t: any) => {
        const isPvzMode = pvzDeliveryModes.includes(t.delivery_mode);
        const isMagistral = (t.tariff_name || '').toLowerCase().includes('магистральный');
        return isPvzMode && !isMagistral;
      });
      
      if (pvzTariffs.length > 0) {
        // Группируем тарифы по типам для лучшего выбора
        // Приоритет: Посылка > Экспресс > Супер-экспресс
        // Магистральный исключен (для больших грузов)
        const tariffPriority = (tariffName: string): number => {
          const name = tariffName.toLowerCase();
          if (name.includes('посылка')) return 1; // Самый приоритетный (дешевый)
          if (name.includes('экспресс') && !name.includes('супер')) return 2;
          if (name.includes('супер-экспресс')) return 3;
          return 4; // Остальные
        };
        
        // Сортируем: сначала по приоритету типа тарифа, затем по цене
        const sortedTariffs = pvzTariffs.sort((a: any, b: any) => {
          const priorityA = tariffPriority(a.tariff_name || '');
          const priorityB = tariffPriority(b.tariff_name || '');
          
          if (priorityA !== priorityB) {
            return priorityA - priorityB; // Сначала по типу (приоритету)
          }
          
          // Если одинаковый тип, сортируем по цене
          const costA = a.delivery_sum || a.total_sum || 0;
          const costB = b.delivery_sum || b.total_sum || 0;
          return costA - costB;
        });
        
        // Выбираем первый (самый дешевый из приоритетных)
        tariff = sortedTariffs[0];
      } else {
        // Если нет подходящих тарифов для ПВЗ, берем первый доступный
        tariff = tariffs[0];
      }
    }
    
    // Проверяем наличие обязательных полей
    // Для tariffAndService используем total_sum (уже включает услуги), для tarifflist - delivery_sum или total_sum

